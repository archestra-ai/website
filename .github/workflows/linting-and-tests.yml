name: Linting and Tests

on:
  workflow_call:

# Set default permissions to empty to enforce least privilege
# Each job will explicitly declare the permissions it needs
permissions: {}

jobs:
  app-linting-formatting-and-tests:
    name: App Linting, Formatting, and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Check prettier formatting
        run: pnpm prettier --check .

      - name: Run tests
        run: pnpm test

      - name: Typecheck
        run: pnpm typecheck

      - name: Build check
        env:
          # on prod build we throw error if DATABASE_URL is not set
          # so we need to set it to a dummy value on CI
          DATABASE_URL: postgresql://user:password@host.tld/dbname?option=value
        run: pnpm build:check

  ensure-catalog-data-is-valid:
    name: Ensure Catalog Data is Valid
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Validate catalog data
        run: pnpm catalog:validate

  verify-no-pending-openapi-schema-changes:
    name: Verify no pending openapi schema changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Codegen
        run: pnpm openapi:generate

      - name: Check for changes
        run: |
          # Check both unstaged and staged changes
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            echo "‚ùå OpenAPI schema has uncommitted changes!"
            echo ""
            echo "The OpenAPI schema is out of sync with the API implementation."
            echo "To fix this, run the following commands locally:"
            echo ""
            echo "  cd app"
            echo "  npm run openapi:generate"
            echo "  git add app/mcp-catalog/api/docs/openapi.json"
            echo "  git commit -m 'chore: update OpenAPI schema'"
            echo ""
            echo "Then push your changes."
            echo ""
            echo "Changes detected:"
            git diff --name-only
            exit 1
          fi

  zizmor:
    name: Zizmor GitHub Actions static analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # From zizmor action docs:
      # https://github.com/zizmorcore/zizmor-action?tab=readme-ov-file#usage-with-github-advanced-security-recommended
      #
      # In this mode, the action will not fail when zizmor produces findings.
      # This is because Advanced Security encourages workflows to only fail on internal errors.
      #
      # To use workflow failure as a blocking signal, you can use GitHub's rulesets feature.
      # For more information, see:
      # https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-code-scanning-alerts#pull-request-check-failures-for-code-scanning-alerts
      - name: Run zizmor üåà
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          config: .github/zizmor.yml
